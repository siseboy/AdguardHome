name: Build & Release AdguardHome

on:
  push:
    branches: [main]
  schedule:
    - cron: "00 04 * * *"
  watch:
    types: [started]
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Step 1 - Checkout
        uses: actions/checkout@v3.1.0
      - name: Step 2 - Build AdguardHome
        run: |
          curl -s "https://raw.githubusercontent.com/siseboy/AdguardHome/source/release.sh" | sudo bash
      - name: Step 3 - Release AdguardHome
        run: |
          sudo git config user.name github-actions
          sudo git config user.email github-actions@github.com
          sudo git add .
          sudo git commit -m "Generated by GitHub Actions"
          sudo git push --force
      - name: Delete old Workflow Runs
        run: |
          # 获取当前工作流程运行的 ID
          RUN_ID=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.AGH_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?event=workflow_dispatch&status=completed" \
            | jq -r '.workflow_runs | sort_by(.created_at) | .[0].id')

          # 删除除当前运行以外的所有工作流程运行记录
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.AGH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/cancel"
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.AGH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/delete"
